<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
[%- USE date -%]
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="description" content="description" />
<meta name="keywords" content="keywords" />
<link href="/app.css" rel="stylesheet" type="text/css" />
<link rel="shortcut icon" href="/favicon.ico"/>
<link rel="stylesheet" href="/jquery-ui.css" type="text/css"/>
<script src="/js/jquery.js" type="text/javascript"></script>
<script src="/js/jquery-ui.js" type="text/javascript"></script>
<link rel="stylesheet" href="/uploadify.css" type="text/css"/>
<script type="text/javascript" src="/js/swfobject.js"></script>
<script type="text/javascript" src="/js/jquery.uploadify.v2.1.4.js"></script>
<script type="text/javascript" src="/js/jquery-print.js"></script>
<title>[% title -%]</title>
<script type="text/javascript">
var errfocus = "";
var ajax_return = "";
$(document).ready(function(){
  $(".mandatory").before("<span style='font-size:20px;font-weight:bold;color:red;padding:0 6px 0 0;'>*<\/span>");
  $("#searchimg").click(function() {
    switch(document.getElementById('dfg').title) {
      case 'Customers':
        document.getElementById('dfg').title = "Suppliers";
        document.getElementById('dfg').innerHTML = "Search Suppliers";
        $("#searchcus").autocomplete("option","minLength",1);
        break;
      case 'Suppliers':
        document.getElementById('dfg').title = "Sales Invoices";
        document.getElementById('dfg').innerHTML = "Search Sales Invoices";
        $("#searchcus").autocomplete("option","minLength",3);
        break;
      case 'Sales Invoices':
        document.getElementById('dfg').title = "Purchase Invoices";
        document.getElementById('dfg').innerHTML = "Search Purchase Invoices";
        $("#searchcus").autocomplete("option","minLength",3);
        break;
      default:
        document.getElementById('dfg').title = "Customers";
        document.getElementById('dfg').innerHTML = "Search Customers";
        $("#searchcus").autocomplete("option","minLength",1);
        break;
    }
  });
  $("#searchcus").autocomplete({
    minLength: 3,
    source: function (request,response) {
      request.type = document.getElementById("dfg").title;
      $.ajax({
        url: "/cgi-bin/fpa/autosuggest.pl",
        dataType: "json",
        data: request,
        success: function( data ) {
          response (data);
        }
      });
    },
    select: function(event, ui) {
      switch(document.getElementById('dfg').title) {
        case 'Customers':
          location.href="/cgi-bin/fpa/list_customer_invoices.pl?" + ui.item.id;
          break;
        case 'Suppliers':
          location.href="/cgi-bin/fpa/list_supplier_purchases.pl?" + ui.item.id;
          break;
        case 'Sales Invoices':
          location.href="/cgi-bin/fpa/update_invoice.pl?" + ui.item.id;
          break;
        case 'Purchase Invoices':
          location.href="/cgi-bin/fpa/update_purchase.pl?" + ui.item.id;
          break;
        default:
          location.href="/cgi-bin/fpa/list_customer_invoices.pl?" + ui.item.id;
          break;
      }
    }
  });
  $.datepicker.setDefaults({showOn: "button", buttonImage: "/images/calendaricon.gif", buttonImageOnly: true, buttonText: "", dateFormat: "dd-M-y", duration: "", changeYear: true,changeMonth: true});
//  $.datepicker.setDefaults({showOn: "button", buttonImage: "/images/calendaricon.gif", buttonImageOnly: true, buttonText: "", dateFormat: "dd-M-y", duration: "", changeYear: true,changeMonth: true, minDate: new Date([%- cookie.MIN -%])});
  $("#rec_cus_id").autocomplete({
    minLength: 0,
    delay: 50,
    source: function (request,response) {
      request.type = "Customers";
      $.ajax({
        url: "/cgi-bin/fpa/autosuggest.pl",
        dataType: "json",
        data: request,
        success: function( data ) {
          response (data);
        }
      });
    },
    select: function(event, ui) {
      document.getElementById("rec_amtcusid").value = ui.item.id;
      $("#rec_invcoa").val(ui.item.coa);
      $("#rec_vatrate").val(ui.item.vatrate);
      $("#rec_txnamount").focus();
    }
  });
  $("#rec_invprintdate").datepicker();
  $("#pay_cus_id").autocomplete({
    minLength: 0,
    delay: 50,
    source: function (request,response) {
      request.type = "Suppliers";
      $.ajax({
        url: "/cgi-bin/fpa/autosuggest.pl",
        dataType: "json",
        data: request,
        success: function( data ) {
          response (data);
        }
      });
    },
    select: function(event, ui) {
      document.getElementById("pay_amtcusid").value = ui.item.id;
      $("#pay_invcoa").val(ui.item.coa);
      $("#pay_vatrate").val(ui.item.vatrate);
      $("#pay_txnamount").focus();
    }
  });
  $("#pay_invprintdate").datepicker();
  $("#remstartdate").datepicker();
  $("#remenddate").datepicker();
  $("#dialog").dialog({
    bgiframe: true,
    height: 200,
    autoOpen: false,
    position: [200,100],
    modal: true,
    buttons: { "Ok": function() { $(this).dialog("close");setfocus(); } }
  });
  $("#vcomments").dialog({
    bgiframe: true,
    height: 200,
    autoOpen: false,
    position: [200,100],
    modal: true
  });
  $("#vcomment").dialog({
    bgiframe: true,
    autoOpen: false,
    position: [200,100],
    height: 350,
    width: 400,
    modal: true,
    buttons: {
      "Save": function() {
        if (document.getElementById("comtext").value.length > 0) {
          $.post("/cgi-bin/fpa/add_comment.pl", { comtext: document.getElementById("comtext").value, comgrade: document.getElementById("comgrade").value },function(data) {
            document.getElementById("dialog").title = "";
            document.getElementById("dialog").innerHTML = data;
            errfocus = "comtext";
            $("#dialog").dialog("open");
            document.getElementById("comtext").value = "";
          },"text");
          $(this).dialog("close");
       }
       else {
          document.getElementById("dialog").innerHTML = "You have not entered any comment";
          errfocus = "comtext";
          $("#dialog").dialog("open");
       }
      },
      Cancel: function() {
        $(this).dialog("close");
      }
    }
  });
  $("#vreminders").dialog({
    bgiframe: true,
    height: 200,
    autoOpen: false,
    position: [200,100],
    modal: true
  });
  $("#vreminder").dialog({
    bgiframe: true,
    autoOpen: false,
    position: [200,100],
    height: 350,
    width: 400,
    modal: true,
    buttons: {
      "Save": function() {
        if (document.getElementById("remtext").value.length > 0) {
          $.post("/cgi-bin/fpa/add_reminder.pl", { remtext: document.getElementById("remtext").value, remgrade: document.getElementById("remgrade").value, remstartdate: document.getElementById("remstartdate").value, remenddate: document.getElementById("remenddate").value } ,function(data) {
            document.getElementById("dialog").title = "";
            document.getElementById("dialog").innerHTML = data;
            errfocus = "remtext";
            $("#dialog").dialog("open");
            document.getElementById("remtext").value = "";
            document.getElementById("remstartdate").value = "";
            document.getElementById("remenddate").value = "";
          },"text");
          $(this).dialog("close");
       }
       else {
          document.getElementById("dialog").innerHTML = "You have not entered any message";
          errfocus = "remtext";
          $("#dialog").dialog("open");
       }
      },
      Cancel: function() {
        $(this).dialog("close");
      }
    }
  });
  $("#receipt2").dialog({
    bgiframe: true,
    autoOpen: false,
    position: [200,100],
    height: 420,
    width: 500,
    modal: true,
    buttons: {
      "Record Receipt": function() {
        if (validate_form("#recform2")) {
          document.getElementById("rec_invcusname").value = document.getElementById("rec_cus_id").value;
          $.post("/cgi-bin/fpa/process_txn.pl", $("form#recform2").serialize(),function(data) {
            if ( ! /^OK/.test(data)) {
              alert(data);
            }
            window.location.reload(true);
          },"text");
          $(this).dialog("close");
        }
      },
      Cancel: function() {
        $(".error").removeClass("error");
        $("#recform2")[0].reset();
        $(this).dialog("close");
      }
    }
  });
  $("#payment2").dialog({
    bgiframe: true,
    autoOpen: false,
    position: [200,100],
    height: 475,
    width: 500,
    modal: true,
    buttons: {
      "Record Payment": function() {
        if (validate_form("#payform2")) {
          document.getElementById("pay_invcusname").value = document.getElementById("pay_cus_id").value;
          $.ajax({ 
            url      : "/cgi-bin/fpa/process_txn.pl", 
            data     : $("form#payform2").serialize(), 
            async    : false, 
            success  : function(data) {
              ajax_return = data;
              if ( ! /^OK/.test(data)) {
                alert(data);
              }
            }
          });
[% IF cookie.UPLDS > 0 -%]
          var href = ajax_return.split("-");
          var c_name = "fpa-cookie";
          var cookie = "";
          if (document.getElementById("pifileQueue").innerHTML.length > 0 && parseInt(href[1]) > 0) {
            if (document.cookie.length>0) {
              c_start=document.cookie.indexOf(c_name + "=");
              if (c_start!=-1) {
                c_start=c_start + c_name.length+1;
                c_end=document.cookie.indexOf(";",c_start);
                if (c_end==-1) c_end=document.cookie.length;
                cookie = unescape(document.cookie.substring(c_start,c_end));
              }
            }
            $("#pifile").uploadifySettings("scriptData",{"cookie" : cookie, "doc_type" : "INV", "doc_rec" : href[1] },true );
            $("#pifile").uploadifyUpload();
          }
[% END -%]
          window.location.reload(true);
          $(this).dialog("close");
        }
      },
      Cancel: function() {
        $(".error").removeClass("error");
        $("#payform2")[0].reset();
        $(this).dialog("close");
      }
    }
  });

//  $("#wrapper").css("height",$(document).height() > 900 ? $(document).height() + 20 : 900);
//  $("#body").css("height",$("#wrapper").height() - 260);
});
function print_display() {
  if ($(".main").length) {
    $(".main").print();
  }
  else {
    window.print();
  }
// alert(document.URL);
}

function validate_form(form) {
  var errs = "";
  $(".error").removeClass("error");
  $(":input.mandatory",form).each(function() {
    if ($(this).is(".mandatory") && $(this).val() == "") {
      errs = errs + "<li>Empty " + this.title + "<\/li>";
      $(this).parent().addClass("error");
      if (errfocus == "") {
        errfocus = this.id;
      }
    }
    else {
      if ($(this).is(".currency") && $(this).val() != "" && ! /^-?\d+\.?\d?\d?$/.test($(this).val())) {
        errs = errs + "<li>" + this.title + "  must contain a valid currency amount (n.nn)<\/li>";
        $(this).parent().addClass("error");
        if (errfocus == "") {
          errfocus = this.id;
        }
      }
    }
  });
  if (errs.length > 0) {
    errs = "You have the following error(s):-<ol>" + errs + "<\/ol>Please correct them before re-submitting";
    document.getElementById("dialog").innerHTML = errs;
    $("#dialog").dialog("open");
    return false;
  }
  else {
    return true;
  }
}
function setfocus() {
  try {eval("document.getElementById(\'" + errfocus + "\').focus();");}
  catch(e) {}
}
function check_currency(obj) {
  if (obj.value.length > 0) {
    if (! /^-?\d+\.?\d?\d?$/.test(obj.value)) {
      document.getElementById("dialog").innerHTML = obj.value + "is an invalid currency format, please correct";
      $("#dialog").dialog("open");
      obj.value="";
      errfocus = obj.id;
    }
  }
}
function calc_vat(obj) {
  if (/^pay/.test(obj.id)) {
    if (/^-?\d+\.?\d?\d?/.test(document.getElementById("pay_txnamount").value)) {
      var totamt = parseFloat(document.getElementById("pay_txnamount").value);
      var vat = parseFloat(document.getElementById("pay_vatrate").value);
      var vatdiv = vat + 1;
      var vatvalue = totamt * vat / vatdiv;
      document.getElementById("pay_invvat").value = vatvalue.toFixed(2);
      var netamt = totamt - vatvalue;
      document.getElementById("pay_netamt").innerHTML = "(Net = " + netamt.toFixed(2) + ")";
    }
    else {
      document.getElementById("pay_invvat").value = "";
      document.getElementById("pay_netamt").innerHTML = "";
    }
  }
  else {
    if (/^-?\d+\.?\d?\d?/.test(document.getElementById("rec_txnamount").value)) {
      var totamt = parseFloat(document.getElementById("rec_txnamount").value);
      var vat = parseFloat(document.getElementById("rec_vatrate").value);
      var vatdiv = vat + 1;
      var vatvalue = totamt * vat / vatdiv;
      document.getElementById("rec_invvat").value = vatvalue.toFixed(2);
      var netamt = totamt - vatvalue;
      document.getElementById("rec_netamt").innerHTML = "(Net = " + netamt.toFixed(2) + ")";
    }
    else {
      document.getElementById("rec_invvat").value = "";
      document.getElementById("rec_netamt").innerHTML = "";
    }
  }
}
function display_form(io) {
  $(".error").removeClass("error");
  if (io == "I") {
    $("#rec_netamt").html("");
    $("#receipt2").dialog("open");
    document.getElementById("rec_cus_id").focus();
  }
  else {
    $("#pay_netamt").html("");
[% IF cookie.UPLDS > 0 -%]
  $("#pifile").uploadify ({
    "uploader"       : "/js/uploadify.swf",
    "script"         : "/cgi-bin/fpa/uploadify.pl",
    "cancelImg"      : "/js/cancel.png",
    "buttonText"     : "Attach Document",
    "fileExt"        : "*.pdf;*.jpg;*.png",
    "fileDesc"       : "PDF or Image Files (*.pdf,*.jpg,*.png)",
    "sizeLimit"      : [%- cookie.UPLDS -%],
    "expressInstall" : "/js/expressInstall.swf",
    "auto"           : false
  });
[% END -%]
    $("#payment2").dialog("open");
    document.getElementById("pay_cus_id").focus();
  }
}
function view_comments() {
  $.ajax({ url: "/cgi-bin/fpa/view_comments.pl", cache: false, success: function(data) {
    document.getElementById("vcomments").innerHTML = data;
    $("#vcomments").dialog("open");
  }});
}
function view_reminders() {
  $.ajax({ url: "/cgi-bin/fpa/view_reminders.pl", cache: false, success: function(data) {
    document.getElementById("vreminders").innerHTML = data;
    $("#vreminders").dialog("open");
  }});
}
function delete_reminder(id) {
  $.get("/cgi-bin/fpa/delete_reminder.pl?" + id,function(data) {
    window.location.reload(true);
  });
}
</script>
[% javascript %]
</head>
<body [%- IF focus -%][%- IF focus.search('location') -%] onload="[%- focus; -%]"[%- ELSE -%] onload="document.getElementById('[%- focus -%]').focus();"[%- END -%][%- END -%]>
<div id="wrapper">
<table width="100%"  cellpadding="0" cellspacing="0" border="0" style="height:103px;background-image:url(/images/header_back.png);background-repeat:repeat-x;">
  <tr>
    <td style="padding:0px;vertical-align:middle;text-align:center;width:120px;"><img src="/logo5.png"/></td>
    <td><h1 id="tagline">[%- cookie.TAG -%]</h1></td>
    <td style="text-align:right;padding:6px;"><a href="http://www.completemarketingservices.com"><img src="/images/sponsor_logo.png"/></a></td>
  </tr>
</table>
<div style="position: absolute; display: inline; top:80px; left:830px;">
  <div id="logout_button">
    <a href="/cgi-bin/fpa/logout.pl"></a>
  </div>
</div>
<div style=" background-image:url(/images/nav_back-old.png);height:70px;">
[% IF cookie.MENU == 'S'; INCLUDE simple_menu.tt; ELSE; INCLUDE full_menu.tt; END -%]
    <div style="float:right;">
    <div id="searchimg"><img src="/icons/search.png"/></div>
    <div style="float:right;padding:10px 25px 0px 0px;">
      <div id="dfg" title="Sales Invoices">Search Sales Invoices</div>
      <input id="searchcus" />
    </div>
    </div>
</div>
<div id="dialog" style="text-align:left;z-index:10100;" title="Errors!"></div>
<div id="vcomments" style="text-align:left;z-index:10100;" title="Feedback"></div>
<div id="vcomment" style="display:none;" title="Add a Comment">
  <form id="fcomment" name="fcomment" method="post" action="/cgi-bin/fpa/comment.pl">
    <table width="100%" cellpadding="4" cellspacing="0" border="0" class="formtable">
      <tr>
        <td style="vertical-align:top;"><label>Comment</label></td>
        <td><textarea name="comtext" id="comtext" cols="30" rows="3"></textarea></td>
      </tr>
      <tr>
        <td><label>Priority</label></td>
        <td>
          <select name="comgrade" id="comgrade">
            <option value="N">Normal</option>
            <option value="H">Important</option>
          </select>
        </td>
      </tr>
    </table>
  </form>
</div>
<div id="vreminders" style="text-align:left;z-index:10100;" title="Reminders"></div>
<div id="vreminder" style="display:none;" title="Add a Reminder">
  <form id="freminder" name="freminder" method="post" action="/cgi-bin/fpa/reminder.pl">
    <table width="100%" cellpadding="4" cellspacing="0" border="0" class="formtable">
      <tr>
        <td style="vertical-align:top;"><label>Message</label></td>
        <td><textarea name="remtext" id="remtext" cols="30" rows="3"></textarea></td>
      </tr>
      <tr>
        <td><label>Priority</label></td>
        <td>
          <select name="remgrade" id="remgrade">
            <option value="N">Normal</option>
            <option value="H">Important</option>
          </select>
        </td>
      </tr>
      <tr>
        <td><label>Show from</label></td>
        <td><input type="text" name="remstartdate" id="remstartdate" size="9" readonly="readonly"/></td>
      </tr>
      <tr>
        <td><label>Show to</label></td>
        <td><input type="text" name="remenddate" id="remenddate" size="9" readonly="readonly"/></td>
      </tr>
    </table>
  </form>
</div>
[% content %]
</div>  <!-- end of wrapper  //-->
<div id="receipt2" title="Receive Money In" style="width:520px;">
  <form id="recform2" name="recform2" method="post" action="/cgi-bin/fpa/process_txn.pl">
    <input type="hidden" name="invtype" id="rec_invtype" value="I"/>
    <input type="hidden" name="searchtype" id="rec_searchtype" value="Customers"/>
    <input type="hidden" name="amtcusid" id="rec_amtcusid" value="0"/>
    <table width="100%" cellpadding="4" cellspacing="0" border="0" class="formtable">
      <tr>
        <td><label>Received From</label></td>
        <td><div><input type="hidden" name="invcusname" id="rec_invcusname" value=""/><input id="rec_cus_id" title="Received From" class="mandatory"/></div></td>
      </tr>
      <tr>
        <td><label>Payment Method</label></td>
        <td>
          <select name="txnmethod" id="rec_txnmethod">
            <option value="1300">Cash</option>
            <option value="1310">Cheque</option>
            <option value="1200" selected="selected">Bank Transfer</option>
          </select>
        </td>
      </tr>
      <tr>
        <td><label>Total Amount Received</label></td>
        <td><span><input type="text" name="txnamount" id="rec_txnamount" value="" size="10" title="Total Amount Received" class="mandatory currency"[%- UNLESS cookie.VAT == "N" -%] onchange="calc_vat(this);"[%- END -%]/></span></td>
      </tr>
[% UNLESS cookie.VAT == "N" -%]
      <tr>
        <td><label>VAT Rate</label></td>
        <td>
          <select name="vatrate" id="rec_vatrate" onchange="calc_vat(this);">
[% INCLUDE vatrates -%]
          </select>
        </td>
      </tr>
      <tr>
        <td><label>VAT Amount</label></td>
        <td><span><input type="text" name="invvat" id="rec_invvat" value="" size="10" title="VAT Amount Received" class="currency"/></span>&nbsp;<span id="rec_netamt"></span></td>
      </tr>
[% END -%]
      <tr>
        <td><label>Allocate to</label></td>
        <td>
          <select name="invcoa" id="rec_invcoa" size="1">
            <option value="4000" selected="selected">UK Sales</option>
            <option value="4100">EU Sales</option>
            <option value="4200">Export Sales</option>
            <option value="4300">Other Income</option>
          </select>
        </td> 
      </tr>
      <tr>
        <td><label>Transaction Date</label></td>
        <td><input type="text" name="invprintdate" id="rec_invprintdate" value="[%- date.format(date.now, '%d-%b-%y') -%]" size="10" readonly="readonly"/></td>
      </tr>
      <tr>
        <td colspan="2"><label style="text-align:left;">Description</label><textarea name="invdesc" id="rec_invdesc" cols="30" rows="2" title="Description of the receipt" class="mandatory"></textarea></td>
      </tr>
    </table>
  </form>
</div>
<div id="payment2" title="Pay Money Out" style="width:520px;">
  <form id="payform2" name="payform2" method="post" action="/cgi-bin/fpa/process_txn.pl">
    <input type="hidden" name="invtype" id="pay_invtype" value="P"/>
    <input type="hidden" name="searchtype" id="pay_searchtype" value="Customers"/>
    <input type="hidden" name="amtcusid" id="pay_amtcusid" value="0"/>
    <table width="100%" cellpadding="4" cellspacing="0" border="0" class="formtable">
      <tr>
        <td><label>Paid To</label></td>
        <td><div><input type="hidden" name="invcusname" id="pay_invcusname" value=""/><input id="pay_cus_id" title="Paid To" class="mandatory"/></div></td>
      </tr>
      <tr>
        <td><label>Payment Method</label></td>
        <td>
          <select name="txnmethod" id="pay_txnmethod">
            <option value="1300">Cash</option>
            <option value="1310">Cheque</option>
            <option value="1200" selected="selected">Bank Transfer</option>
            <option value="2010">Credit Card</option>
          </select>
        </td>
      </tr>
      <tr>
        <td><label>Total Amount Paid</label></td>
        <td><span><input type="text" name="txnamount" id="pay_txnamount" value="" size="10" title="Total Amount Paid" class="mandatory currency"[%- UNLESS cookie.VAT == "N" -%] onchange="calc_vat(this);"[%- END -%]/></span></td>
      </tr>
[% UNLESS cookie.VAT == "N" -%]
      <tr>
        <td><label>VAT Rate</label></td>
        <td>
          <select name="vatrate" id="pay_vatrate" onchange="calc_vat(this);">
[% INCLUDE vatrates -%]
          </select>
        </td>
      </tr>
      <tr>
        <td><label>VAT Amount</label></td>
        <td><input type="text" name="invvat" id="pay_invvat" value="" size="10" title="VAT Amount Paid" class="currency"/>&nbsp;<span id="pay_netamt"></span></td>
      </tr>
[% END -%]
      <tr>
        <td><label>Allocate to</label></td>
        <td>
          <select name="invcoa" id="pay_invcoa" size="1">
            <option value="5000">Cost of Sales</option>
            <option value="6000" selected="selected">Other Expenses</option>
            <option value="7000">Fixed Overheads</option>
            <option value="1000">Fixed Assets</option>
            <option value="1500">Other Current Assets</option>
          </select>
        </td> 
      </tr>
      <tr>
        <td><label>Transaction Date</label></td>
        <td><input type="text" name="invprintdate" id="pay_invprintdate" value="[%- date.format(date.now, '%d-%b-%y') -%]" size="10" readonly="readonly"/></td>
      </tr>
      <tr>
        <td><label>Supplier Reference</label></td>
        <td><span><input type="text" name="invcusref" id="pay_invcusref" value="" title="Supplier Reference"/></span></td>
      </tr>
      <tr>
        <td colspan="2"><label style="text-align:left;">Description</label><textarea name="invdesc" id="pay_invdesc" cols="30" rows="2" title="Description of the payment" class="mandatory"></textarea>[%- IF cookie.UPLDS > 0 -%]&nbsp;&nbsp;<input id="pifile" name="pifile" type="file"/>[%- END -%]</td>
      </tr>
    </table>
  </form>
</div>
</body>
</html>
